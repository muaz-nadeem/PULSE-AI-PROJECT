{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/logger.ts"],"sourcesContent":["/**\r\n * AI System Logger\r\n * Provides structured logging for AI operations, useful for debugging and monitoring.\r\n */\r\n\r\ninterface LogEntry {\r\n  timestamp: string;\r\n  event: string;\r\n  data: Record<string, unknown>;\r\n}\r\n\r\ninterface ErrorEntry {\r\n  timestamp: string;\r\n  error: {\r\n    message: string;\r\n    stack?: string;\r\n  };\r\n  context: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Logs an AI-related event with structured data.\r\n * In development, logs to console. In production, can be extended to send to monitoring services.\r\n */\r\nexport function logAIEvent(event: string, data: Record<string, unknown>): void {\r\n  const logEntry: LogEntry = {\r\n    timestamp: new Date().toISOString(),\r\n    event,\r\n    data,\r\n  };\r\n\r\n  // Development: console logging\r\n  if (process.env.NODE_ENV === 'development') {\r\n    console.log('[AI]', JSON.stringify(logEntry, null, 2));\r\n  } else {\r\n    // Production: structured logging (can be picked up by Vercel logs, etc.)\r\n    console.log('[AI]', JSON.stringify(logEntry));\r\n  }\r\n\r\n  // TODO: Add integration with monitoring service (e.g., Sentry, LogRocket, Datadog)\r\n  // Example:\r\n  // if (process.env.NODE_ENV === 'production' && typeof window === 'undefined') {\r\n  //   sendToMonitoringService(logEntry);\r\n  // }\r\n}\r\n\r\n/**\r\n * Logs an AI-related error with context.\r\n * Always logs to console.error and can be extended for error tracking services.\r\n */\r\nexport function logAIError(error: Error, context: Record<string, unknown>): void {\r\n  const errorEntry: ErrorEntry = {\r\n    timestamp: new Date().toISOString(),\r\n    error: {\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    context,\r\n  };\r\n\r\n  console.error('[AI ERROR]', JSON.stringify(errorEntry, null, 2));\r\n\r\n  // TODO: Add integration with error tracking service\r\n  // Example:\r\n  // if (process.env.NODE_ENV === 'production') {\r\n  //   Sentry.captureException(error, { extra: context });\r\n  // }\r\n}\r\n\r\n/**\r\n * Logs metrics for AI operations (latency, token usage, etc.)\r\n */\r\nexport function logAIMetrics(operation: string, metrics: {\r\n  latencyMs: number;\r\n  promptTokens?: number;\r\n  completionTokens?: number;\r\n  success: boolean;\r\n  userId?: string;\r\n}): void {\r\n  logAIEvent('ai_metrics', {\r\n    operation,\r\n    ...metrics,\r\n  });\r\n}\r\n\r\n/**\r\n * Logs when an AI feature is used\r\n */\r\nexport function logAIFeatureUsage(feature: string, userId: string, metadata?: Record<string, unknown>): void {\r\n  logAIEvent('ai_feature_usage', {\r\n    feature,\r\n    userId,\r\n    ...metadata,\r\n  });\r\n}\r\n\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;AAqBM,SAAS,WAAW,KAAa,EAAE,IAA6B;IACrE,MAAM,WAAqB;QACzB,WAAW,IAAI,OAAO,WAAW;QACjC;QACA;IACF;IAEA,+BAA+B;IAC/B,wCAA4C;QAC1C,QAAQ,GAAG,CAAC,QAAQ,KAAK,SAAS,CAAC,UAAU,MAAM;IACrD;;AAKA,mFAAmF;AACnF,WAAW;AACX,gFAAgF;AAChF,uCAAuC;AACvC,IAAI;AACN;AAMO,SAAS,WAAW,KAAY,EAAE,OAAgC;IACvE,MAAM,aAAyB;QAC7B,WAAW,IAAI,OAAO,WAAW;QACjC,OAAO;YACL,SAAS,MAAM,OAAO;YACtB,OAAO,MAAM,KAAK;QACpB;QACA;IACF;IAEA,QAAQ,KAAK,CAAC,cAAc,KAAK,SAAS,CAAC,YAAY,MAAM;AAE7D,oDAAoD;AACpD,WAAW;AACX,+CAA+C;AAC/C,wDAAwD;AACxD,IAAI;AACN;AAKO,SAAS,aAAa,SAAiB,EAAE,OAM/C;IACC,WAAW,cAAc;QACvB;QACA,GAAG,OAAO;IACZ;AACF;AAKO,SAAS,kBAAkB,OAAe,EAAE,MAAc,EAAE,QAAkC;IACnG,WAAW,oBAAoB;QAC7B;QACA;QACA,GAAG,QAAQ;IACb;AACF"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/gemini-client.ts"],"sourcesContent":["import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from '@google/generative-ai';\r\nimport type { GeminiMessage, GeminiResponse } from './types';\r\nimport { logAIEvent, logAIError } from './logger';\r\n\r\n// Initialize Gemini client\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');\r\n\r\n// Safety settings to allow productivity-related content\r\nconst safetySettings = [\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_HARASSMENT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n];\r\n\r\n/**\r\n * Calls the Gemini API with the provided prompt and optional conversation history.\r\n * \r\n * @param prompt - The user's message or request\r\n * @param systemInstruction - Optional system-level instruction for the model\r\n * @param conversationHistory - Optional array of previous messages for context\r\n * @returns GeminiResponse with text and usage information\r\n */\r\nexport async function callGemini(\r\n  prompt: string,\r\n  systemInstruction?: string,\r\n  conversationHistory?: GeminiMessage[]\r\n): Promise<GeminiResponse> {\r\n  if (!process.env.GEMINI_API_KEY) {\r\n    throw new Error('GEMINI_API_KEY environment variable is not set');\r\n  }\r\n\r\n  const startTime = Date.now();\r\n  \r\n  try {\r\n    const model = genAI.getGenerativeModel({\r\n      model: 'gemini-1.5-flash', // Using flash for faster responses, can upgrade to pro\r\n      systemInstruction: systemInstruction,\r\n      safetySettings,\r\n      generationConfig: {\r\n        temperature: 0.7,\r\n        topP: 0.95,\r\n        topK: 40,\r\n        maxOutputTokens: 2048,\r\n      },\r\n    });\r\n\r\n    let result;\r\n    \r\n    if (conversationHistory && conversationHistory.length > 0) {\r\n      // Use chat mode for conversations\r\n      const chat = model.startChat({\r\n        history: conversationHistory.map(msg => ({\r\n          role: msg.role,\r\n          parts: [{ text: msg.parts }],\r\n        })),\r\n      });\r\n      result = await chat.sendMessage(prompt);\r\n    } else {\r\n      // Use simple generation for single prompts\r\n      result = await model.generateContent(prompt);\r\n    }\r\n\r\n    const response = result.response;\r\n    const text = response.text();\r\n    const latency = Date.now() - startTime;\r\n\r\n    logAIEvent('gemini_call_success', {\r\n      latencyMs: latency,\r\n      promptLength: prompt.length,\r\n      responseLength: text.length,\r\n      promptTokens: response.usageMetadata?.promptTokenCount || 0,\r\n      completionTokens: response.usageMetadata?.candidatesTokenCount || 0,\r\n    });\r\n\r\n    return {\r\n      text,\r\n      usage: {\r\n        promptTokens: response.usageMetadata?.promptTokenCount || 0,\r\n        completionTokens: response.usageMetadata?.candidatesTokenCount || 0,\r\n      },\r\n    };\r\n  } catch (error) {\r\n    const latency = Date.now() - startTime;\r\n    logAIError(error as Error, { \r\n      operation: 'callGemini',\r\n      latencyMs: latency,\r\n      promptLength: prompt.length,\r\n    });\r\n    throw new Error(`Gemini API call failed: ${(error as Error).message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Calls Gemini expecting a JSON response. Automatically parses and validates the output.\r\n * \r\n * @param prompt - The prompt requesting JSON output\r\n * @param systemInstruction - Optional system instruction\r\n * @returns Parsed JSON object\r\n */\r\nexport async function callGeminiJSON<T>(\r\n  prompt: string,\r\n  systemInstruction?: string\r\n): Promise<T> {\r\n  const response = await callGemini(prompt, systemInstruction);\r\n  \r\n  try {\r\n    // Try to extract JSON from the response\r\n    let jsonText = response.text.trim();\r\n    \r\n    // Handle markdown code blocks\r\n    if (jsonText.startsWith('```json')) {\r\n      jsonText = jsonText.slice(7);\r\n    } else if (jsonText.startsWith('```')) {\r\n      jsonText = jsonText.slice(3);\r\n    }\r\n    if (jsonText.endsWith('```')) {\r\n      jsonText = jsonText.slice(0, -3);\r\n    }\r\n    \r\n    jsonText = jsonText.trim();\r\n    \r\n    const parsed = JSON.parse(jsonText) as T;\r\n    return parsed;\r\n  } catch (parseError) {\r\n    logAIError(parseError as Error, {\r\n      operation: 'callGeminiJSON',\r\n      rawResponse: response.text.slice(0, 500),\r\n    });\r\n    throw new Error(`Failed to parse Gemini response as JSON: ${(parseError as Error).message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Validates that the Gemini API key is configured.\r\n */\r\nexport function isGeminiConfigured(): boolean {\r\n  return !!process.env.GEMINI_API_KEY;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 268, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/prompt-builder.ts"],"sourcesContent":["import type { ScheduleContext, Task, Goal, UserAIProfile, DailyAggregate } from './types';\r\n\r\n/**\r\n * Builds a prompt for generating a daily schedule using Gemini.\r\n * Includes user profile, recent performance data, and current tasks.\r\n */\r\nexport function buildSchedulePrompt(context: ScheduleContext): string {\r\n  const { user, profile, recentAggregates, todaysTasks, activeGoals } = context;\r\n\r\n  // Compute summary stats from recent aggregates\r\n  const avgFocusTime = recentAggregates.length > 0\r\n    ? recentAggregates.reduce((sum, a) => sum + (a.total_focus_minutes || 0), 0) / recentAggregates.length\r\n    : 0;\r\n  const avgCompletionRate = recentAggregates.length > 0\r\n    ? recentAggregates.reduce((sum, a) => sum + (a.completion_rate || 0), 0) / recentAggregates.length\r\n    : 0;\r\n  const avgDailyRating = recentAggregates.filter(a => a.daily_rating).length > 0\r\n    ? recentAggregates.filter(a => a.daily_rating).reduce((sum, a) => sum + (a.daily_rating || 0), 0) / recentAggregates.filter(a => a.daily_rating).length\r\n    : null;\r\n\r\n  // Format productive hours\r\n  const productiveHoursStr = profile.most_productive_hours.length > 0\r\n    ? profile.most_productive_hours.map(h => `${h}:00`).join(', ')\r\n    : 'Not yet determined';\r\n\r\n  // Format distraction times\r\n  const distractionTimesStr = profile.common_distraction_times.length > 0\r\n    ? profile.common_distraction_times.map(h => `${h}:00`).join(', ')\r\n    : 'None identified';\r\n\r\n  // Sort tasks by priority\r\n  const sortedTasks = [...todaysTasks].sort((a, b) => {\r\n    const priorityOrder = { high: 0, medium: 1, low: 2 };\r\n    return priorityOrder[a.priority] - priorityOrder[b.priority];\r\n  });\r\n\r\n  return `You are an AI productivity coach helping ${user.name || 'the user'} plan their day.\r\n\r\n**User's Personalization Profile:**\r\n- Optimal focus duration: ${profile.optimal_focus_duration} minutes\r\n- Preferred work hours: ${profile.preferred_work_start_hour}:00 - ${profile.preferred_work_end_hour}:00\r\n- Preferred break duration: ${profile.preferred_break_duration} minutes\r\n- Most productive hours: ${productiveHoursStr}\r\n- Common distraction times: ${distractionTimesStr}\r\n\r\n**Recent Performance (last ${recentAggregates.length} days):**\r\n- Average focus time: ${Math.round(avgFocusTime)} minutes/day\r\n- Average task completion rate: ${(avgCompletionRate * 100).toFixed(1)}%\r\n- Plan acceptance rate: ${((profile.avg_plan_acceptance_rate || 0) * 100).toFixed(1)}%\r\n${avgDailyRating ? `- Average daily satisfaction: ${avgDailyRating.toFixed(1)}/10` : ''}\r\n\r\n**Today's Tasks (${sortedTasks.length} total):**\r\n${sortedTasks.slice(0, 10).map((t, i) =>\r\n    `${i + 1}. [${t.priority.toUpperCase()}] ${t.title} (${t.timeEstimate} min)${t.dueDate ? ` - Due: ${t.dueDate}` : ''}${t.category ? ` [${t.category}]` : ''}`\r\n  ).join('\\n')}\r\n${sortedTasks.length > 10 ? `\\n... and ${sortedTasks.length - 10} more tasks` : ''}\r\n${sortedTasks.length === 0 ? 'No tasks scheduled yet. Suggest a productive day structure.' : ''}\r\n\r\n**Active Goals:**\r\n${activeGoals.slice(0, 5).map(g => `- ${g.title} (${g.progress}% complete)${g.targetDate ? ` - Target: ${g.targetDate}` : ''}`).join('\\n')}\r\n${activeGoals.length === 0 ? 'No active goals set.' : ''}\r\n\r\n**Current Time:** ${context.currentTime}\r\n\r\n**Instructions:**\r\n1. Create a realistic schedule for today starting from the current time\r\n2. Prioritize high-priority tasks during the user's most productive hours (${productiveHoursStr})\r\n3. Include breaks of ${profile.preferred_break_duration} minutes after every ${profile.optimal_focus_duration} minutes of work\r\n4. Avoid scheduling demanding tasks during distraction-prone times (${distractionTimesStr})\r\n5. Keep focus blocks around ${profile.optimal_focus_duration} minutes\r\n6. Leave some buffer time between tasks\r\n7. Consider task due dates when prioritizing\r\n\r\nReturn a JSON object with this exact structure:\r\n{\r\n  \"schedule\": [\r\n    {\r\n      \"time\": \"HH:MM\",\r\n      \"duration\": <minutes as number>,\r\n      \"task\": \"<task description>\",\r\n      \"priority\": \"high\" | \"medium\" | \"low\",\r\n      \"taskId\": \"<task id if matching a user task, or null>\",\r\n      \"type\": \"work\" | \"break\" | \"meeting\"\r\n    }\r\n  ],\r\n  \"explanation\": \"<2-3 sentence personalized explanation of why this schedule is optimized for the user>\",\r\n  \"reasoning\": {\r\n    \"focusHours\": [\"<hours where deep work is scheduled>\"],\r\n    \"breakStrategy\": \"<brief explanation of break placement>\",\r\n    \"prioritization\": \"<brief explanation of task order>\"\r\n  }\r\n}\r\n\r\nImportant: Ensure the JSON is valid and parseable.`;\r\n}\r\n\r\n/**\r\n * Builds a system instruction for schedule generation.\r\n */\r\nexport function getScheduleSystemInstruction(): string {\r\n  return `You are an expert productivity coach AI. Your role is to create personalized daily schedules that maximize the user's productivity while maintaining work-life balance.\r\n\r\nKey principles:\r\n- Always respect the user's preferred work hours\r\n- Schedule high-priority and cognitively demanding tasks during peak productivity hours\r\n- Include regular breaks to prevent burnout\r\n- Be realistic about time estimates\r\n- Consider task dependencies and energy levels throughout the day\r\n- Always respond with valid, parseable JSON matching the requested schema\r\n- Keep explanations concise but personalized`;\r\n}\r\n\r\n/**\r\n * Builds a prompt for the AI Coach conversation feature.\r\n */\r\nexport function buildCoachPrompt(\r\n  userMessage: string,\r\n  context: {\r\n    recentTasks: Task[];\r\n    recentFocus: { totalMinutes: number; sessionCount?: number };\r\n    currentGoals: Goal[];\r\n    todaysPlan?: { accepted: boolean; tasksCompleted: number; totalTasks: number };\r\n  },\r\n  conversationHistory: { role: string; message: string }[]\r\n): string {\r\n  const completedTasks = context.recentTasks.filter(t => t.completed).length;\r\n  const totalTasks = context.recentTasks.length;\r\n  const completionRate = totalTasks > 0 ? (completedTasks / totalTasks * 100).toFixed(0) : 0;\r\n\r\n  return `The user just said: \"${userMessage}\"\r\n\r\n**Current User Context:**\r\n- Recent tasks: ${totalTasks} tasks (${completedTasks} completed, ${completionRate}% completion rate)\r\n- Recent focus time: ${context.recentFocus.totalMinutes} minutes${context.recentFocus.sessionCount ? ` across ${context.recentFocus.sessionCount} sessions` : ''}\r\n- Active goals: ${context.currentGoals.length} goals in progress\r\n${context.todaysPlan ? `- Today's plan: ${context.todaysPlan.accepted ? 'Accepted' : 'Pending'}, ${context.todaysPlan.tasksCompleted}/${context.todaysPlan.totalTasks} tasks done` : ''}\r\n\r\n**Recent Conversation:**\r\n${conversationHistory.slice(-5).map(h => `${h.role === 'user' ? 'User' : 'Coach'}: ${h.message}`).join('\\n')}\r\n\r\nRespond as a supportive, knowledgeable productivity coach. Reference their actual data when relevant. Keep responses concise (2-4 sentences) and actionable.`;\r\n}\r\n\r\n/**\r\n * Builds a system instruction for the AI Coach.\r\n */\r\nexport function getCoachSystemInstruction(): string {\r\n  return `You are a supportive and knowledgeable AI productivity coach called \"Pulse Coach\". Your personality is:\r\n- Encouraging but realistic\r\n- Data-driven (reference user's actual stats when helpful)\r\n- Action-oriented (give specific, practical advice)\r\n- Empathetic (acknowledge challenges and celebrate wins)\r\n\r\nGuidelines:\r\n- Keep responses concise (2-4 sentences max)\r\n- Offer specific suggestions when asked for help\r\n- Celebrate achievements and progress\r\n- Provide gentle accountability when needed\r\n- Never be preachy or condescending\r\n- Reference the user's actual data to personalize advice`;\r\n}\r\n\r\n/**\r\n * Sanitizes user input to prevent prompt injection.\r\n */\r\nexport function sanitizeUserInput(input: string): string {\r\n  // Remove potential instruction override attempts\r\n  let sanitized = input\r\n    .replace(/system:/gi, '[filtered]')\r\n    .replace(/instruction:/gi, '[filtered]')\r\n    .replace(/ignore previous/gi, '[filtered]')\r\n    .replace(/disregard/gi, '[filtered]');\r\n  \r\n  // Limit length\r\n  if (sanitized.length > 2000) {\r\n    sanitized = sanitized.slice(0, 2000) + '...';\r\n  }\r\n  \r\n  return sanitized;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/coach-service.ts"],"sourcesContent":["import { callGemini } from './gemini-client';\r\nimport { buildCoachPrompt, getCoachSystemInstruction, sanitizeUserInput } from './prompt-builder';\r\nimport type { Task, Goal, GeminiMessage } from './types';\r\nimport { logAIEvent, logAIError, logAIMetrics } from './logger';\r\n\r\nexport interface CoachContext {\r\n  recentTasks: Task[];\r\n  recentFocus: {\r\n    totalMinutes: number;\r\n    sessionCount?: number;\r\n  };\r\n  currentGoals: Goal[];\r\n  todaysPlan?: {\r\n    accepted: boolean;\r\n    tasksCompleted: number;\r\n    totalTasks: number;\r\n  };\r\n}\r\n\r\nexport interface ConversationMessage {\r\n  role: 'user' | 'assistant';\r\n  message: string;\r\n}\r\n\r\n/**\r\n * Generates a coach response using Gemini AI.\r\n */\r\nexport async function getCoachResponse(\r\n  userId: string,\r\n  userMessage: string,\r\n  context: CoachContext,\r\n  conversationHistory: ConversationMessage[]\r\n): Promise<string> {\r\n  const startTime = Date.now();\r\n\r\n  logAIEvent('coach_request_start', {\r\n    userId,\r\n    messageLength: userMessage.length,\r\n    historyLength: conversationHistory.length,\r\n  });\r\n\r\n  try {\r\n    // Sanitize user input to prevent prompt injection\r\n    const sanitizedMessage = sanitizeUserInput(userMessage);\r\n\r\n    // Build the prompt\r\n    const prompt = buildCoachPrompt(sanitizedMessage, context, conversationHistory);\r\n    const systemInstruction = getCoachSystemInstruction();\r\n\r\n    // Convert conversation history to Gemini format\r\n    const geminiHistory: GeminiMessage[] = conversationHistory.slice(-10).map(msg => ({\r\n      role: msg.role === 'user' ? 'user' : 'model',\r\n      parts: msg.message,\r\n    }));\r\n\r\n    // Call Gemini\r\n    const response = await callGemini(prompt, systemInstruction, geminiHistory);\r\n\r\n    const latency = Date.now() - startTime;\r\n\r\n    logAIMetrics('coach_response', {\r\n      latencyMs: latency,\r\n      success: true,\r\n      userId,\r\n    });\r\n\r\n    logAIEvent('coach_response_success', {\r\n      userId,\r\n      latencyMs: latency,\r\n      responseLength: response.text.length,\r\n    });\r\n\r\n    return response.text;\r\n  } catch (error) {\r\n    const latency = Date.now() - startTime;\r\n\r\n    logAIMetrics('coach_response', {\r\n      latencyMs: latency,\r\n      success: false,\r\n      userId,\r\n    });\r\n\r\n    logAIError(error as Error, {\r\n      operation: 'getCoachResponse',\r\n      userId,\r\n      messagePreview: userMessage.slice(0, 100),\r\n    });\r\n\r\n    // Return a friendly fallback message\r\n    return getFallbackCoachResponse(userMessage);\r\n  }\r\n}\r\n\r\n/**\r\n * Generates a fallback response when AI is unavailable.\r\n */\r\nfunction getFallbackCoachResponse(userMessage: string): string {\r\n  const lowerMessage = userMessage.toLowerCase();\r\n\r\n  // Try to match common queries\r\n  if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {\r\n    return \"I can help you with productivity tips, task prioritization, focus strategies, and goal tracking. I'm having some connection issues right now, but feel free to ask me anything!\";\r\n  }\r\n\r\n  if (lowerMessage.includes('focus') || lowerMessage.includes('concentrate')) {\r\n    return \"For better focus, try the Pomodoro technique: 25 minutes of focused work followed by a 5-minute break. Also, consider silencing notifications during deep work sessions.\";\r\n  }\r\n\r\n  if (lowerMessage.includes('task') || lowerMessage.includes('priorit')) {\r\n    return \"A good approach is to tackle your most important or difficult task first thing when your energy is highest. Try categorizing tasks by urgency and importance.\";\r\n  }\r\n\r\n  if (lowerMessage.includes('break') || lowerMessage.includes('tired')) {\r\n    return \"Taking regular breaks is essential! Try stepping away from your screen, doing some light stretching, or taking a short walk. Your brain needs rest to perform at its best.\";\r\n  }\r\n\r\n  if (lowerMessage.includes('goal') || lowerMessage.includes('achieve')) {\r\n    return \"Break your goals into smaller, actionable milestones. Celebrate each milestone to stay motivated, and review your progress regularly to stay on track.\";\r\n  }\r\n\r\n  // Default response\r\n  return \"Thanks for reaching out! I'm here to help with your productivity journey. I'm experiencing some temporary issues, but please feel free to ask me about tasks, focus strategies, or goal planning.\";\r\n}\r\n\r\n/**\r\n * Quick responses for common coach interactions that don't need AI.\r\n */\r\nexport function getQuickResponse(intent: string): string | null {\r\n  const quickResponses: Record<string, string> = {\r\n    greeting: \"Hey! Ready to make today productive. How can I help?\",\r\n    thanks: \"You're welcome! Keep up the great work. ðŸ’ª\",\r\n    bye: \"Good luck with your tasks! Remember, progress over perfection.\",\r\n  };\r\n\r\n  return quickResponses[intent] || null;\r\n}\r\n\r\n/**\r\n * Detects simple intents that don't need full AI processing.\r\n */\r\nexport function detectSimpleIntent(message: string): string | null {\r\n  const lowerMessage = message.toLowerCase().trim();\r\n\r\n  // Greetings\r\n  if (/^(hi|hello|hey|good morning|good afternoon|good evening)[\\s!.]*$/i.test(lowerMessage)) {\r\n    return 'greeting';\r\n  }\r\n\r\n  // Thanks\r\n  if (/^(thanks|thank you|thx|ty)[\\s!.]*$/i.test(lowerMessage)) {\r\n    return 'thanks';\r\n  }\r\n\r\n  // Goodbye\r\n  if (/^(bye|goodbye|see you|later|cya)[\\s!.]*$/i.test(lowerMessage)) {\r\n    return 'bye';\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Main entry point for coach messages. Handles simple intents locally,\r\n * falls back to AI for complex queries.\r\n */\r\nexport async function processCoachMessage(\r\n  userId: string,\r\n  userMessage: string,\r\n  context: CoachContext,\r\n  conversationHistory: ConversationMessage[]\r\n): Promise<string> {\r\n  // Check for simple intents first\r\n  const simpleIntent = detectSimpleIntent(userMessage);\r\n  if (simpleIntent) {\r\n    const quickResponse = getQuickResponse(simpleIntent);\r\n    if (quickResponse) {\r\n      logAIEvent('coach_quick_response', { userId, intent: simpleIntent });\r\n      return quickResponse;\r\n    }\r\n  }\r\n\r\n  // Use AI for complex messages\r\n  return getCoachResponse(userId, userMessage, context, conversationHistory);\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 546, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/types.ts"],"sourcesContent":["// AI System TypeScript Types\r\n\r\nexport interface GeminiMessage {\r\n  role: 'user' | 'model';\r\n  parts: string;\r\n}\r\n\r\nexport interface GeminiResponse {\r\n  text: string;\r\n  usage?: {\r\n    promptTokens: number;\r\n    completionTokens: number;\r\n  };\r\n}\r\n\r\nexport interface ScheduleItem {\r\n  time: string; // HH:MM format\r\n  duration: number; // minutes\r\n  task: string;\r\n  priority: 'high' | 'medium' | 'low';\r\n  taskId?: string;\r\n  type: 'work' | 'break' | 'meeting';\r\n}\r\n\r\nexport interface AISchedule {\r\n  userId: string;\r\n  schedule: ScheduleItem[];\r\n  explanation: string;\r\n  reasoning: {\r\n    focusHours?: string[];\r\n    breakStrategy?: string;\r\n    prioritization?: string;\r\n  };\r\n  modelVersion: string;\r\n  generatedAt: Date;\r\n}\r\n\r\nexport interface DailyAggregate {\r\n  id: string;\r\n  user_id: string;\r\n  date: string;\r\n  total_focus_minutes: number;\r\n  focus_session_count: number;\r\n  avg_focus_duration: number;\r\n  longest_focus_session: number;\r\n  tasks_completed: number;\r\n  tasks_created: number;\r\n  high_priority_completed: number;\r\n  completion_rate: number;\r\n  distraction_count: number;\r\n  total_distraction_minutes: number;\r\n  hourly_activity: number[];\r\n  mood_score: number | null;\r\n  daily_rating: number | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface UserAIProfile {\r\n  id: string;\r\n  user_id: string;\r\n  optimal_focus_duration: number;\r\n  preferred_work_start_hour: number;\r\n  preferred_work_end_hour: number;\r\n  preferred_break_duration: number;\r\n  hourly_performance_scores: number[];\r\n  most_productive_hours: number[];\r\n  common_distraction_times: number[];\r\n  total_plans_generated: number;\r\n  total_plans_accepted: number;\r\n  total_plans_rejected: number;\r\n  avg_plan_acceptance_rate: number;\r\n  last_analyzed_date: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface AIPlan {\r\n  id: string;\r\n  user_id: string;\r\n  plan_date: string;\r\n  schedule: ScheduleItem[];\r\n  explanation: string;\r\n  reasoning: Record<string, unknown>;\r\n  generated_at: string;\r\n  model_version: string;\r\n  status: 'pending' | 'accepted' | 'rejected' | 'edited' | 'expired';\r\n  accepted_at: string | null;\r\n  rejected_at: string | null;\r\n  original_schedule: ScheduleItem[] | null;\r\n  edit_count: number;\r\n  last_edited_at: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface PlanFeedbackEvent {\r\n  id: string;\r\n  plan_id: string;\r\n  user_id: string;\r\n  event_type: 'accepted' | 'rejected' | 'edited' | 'task_completed' | 'task_skipped';\r\n  event_data: Record<string, unknown> | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface ChatMessage {\r\n  id: string;\r\n  user_id: string;\r\n  role: 'user' | 'assistant';\r\n  message: string;\r\n  context_snapshot: Record<string, unknown> | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface ScheduleContext {\r\n  user: {\r\n    name: string;\r\n    timezone: string;\r\n  };\r\n  profile: UserAIProfile;\r\n  recentAggregates: DailyAggregate[];\r\n  todaysTasks: Task[];\r\n  activeGoals: Goal[];\r\n  currentTime: string;\r\n}\r\n\r\n// Re-export types from store for convenience\r\nexport interface Task {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  priority: 'high' | 'medium' | 'low';\r\n  timeEstimate: number;\r\n  completed: boolean;\r\n  createdAt: Date;\r\n  category?: string;\r\n  dueDate?: string;\r\n  focusMode?: boolean;\r\n}\r\n\r\nexport interface Goal {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  category: string;\r\n  targetDate?: string;\r\n  createdAt: Date;\r\n  milestones: Milestone[];\r\n  progress: number;\r\n  status: 'active' | 'completed' | 'paused';\r\n  color: string;\r\n}\r\n\r\nexport interface Milestone {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  completed: boolean;\r\n  dueDate?: string;\r\n  completedDate?: string;\r\n  order: number;\r\n}\r\n\r\n// AI Config\r\nexport interface AIConfig {\r\n  featuresEnabled: boolean;\r\n  dailyBrainEnabled: boolean;\r\n  coachEnabled: boolean;\r\n}\r\n\r\nexport const aiConfig: AIConfig = {\r\n  featuresEnabled: process.env.NEXT_PUBLIC_AI_FEATURES_ENABLED === 'true',\r\n  dailyBrainEnabled: process.env.AI_DAILY_BRAIN_ENABLED === 'true',\r\n  coachEnabled: process.env.AI_COACH_ENABLED === 'true',\r\n};\r\n\r\n// Default profile for new users\r\nexport function getDefaultProfile(): Omit<UserAIProfile, 'id' | 'user_id' | 'created_at' | 'updated_at'> {\r\n  return {\r\n    optimal_focus_duration: 25,\r\n    preferred_work_start_hour: 9,\r\n    preferred_work_end_hour: 17,\r\n    preferred_break_duration: 5,\r\n    most_productive_hours: [9, 10, 11],\r\n    common_distraction_times: [],\r\n    hourly_performance_scores: new Array(24).fill(0.5),\r\n    total_plans_generated: 0,\r\n    total_plans_accepted: 0,\r\n    total_plans_rejected: 0,\r\n    avg_plan_acceptance_rate: 0,\r\n    last_analyzed_date: null,\r\n  };\r\n}\r\n\r\n"],"names":[],"mappings":"AAAA,6BAA6B;;;;;;;AA0KtB,MAAM,WAAqB;IAChC,iBAAiB,QAAQ,GAAG,CAAC,+BAA+B,KAAK;IACjE,mBAAmB,QAAQ,GAAG,CAAC,sBAAsB,KAAK;IAC1D,cAAc,QAAQ,GAAG,CAAC,gBAAgB,KAAK;AACjD;AAGO,SAAS;IACd,OAAO;QACL,wBAAwB;QACxB,2BAA2B;QAC3B,yBAAyB;QACzB,0BAA0B;QAC1B,uBAAuB;YAAC;YAAG;YAAI;SAAG;QAClC,0BAA0B,EAAE;QAC5B,2BAA2B,IAAI,MAAM,IAAI,IAAI,CAAC;QAC9C,uBAAuB;QACvB,sBAAsB;QACtB,sBAAsB;QACtB,0BAA0B;QAC1B,oBAAoB;IACtB;AACF"}},
    {"offset": {"line": 582, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/app/api/ai/coach/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { processCoachMessage, type CoachContext, type ConversationMessage } from '@/lib/ai/coach-service';\r\nimport { logAIEvent, logAIError, logAIFeatureUsage } from '@/lib/ai/logger';\r\nimport { aiConfig } from '@/lib/ai/types';\r\nimport { sanitizeUserInput } from '@/lib/ai/prompt-builder';\r\n\r\n/**\r\n * AI Coach Chat Endpoint\r\n * \r\n * Processes user messages and returns AI-powered coach responses.\r\n * Uses Gemini for intelligent, context-aware productivity coaching.\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  // Check if AI coach is enabled\r\n  if (!aiConfig.featuresEnabled || !aiConfig.coachEnabled) {\r\n    return NextResponse.json({ \r\n      error: 'AI Coach is disabled' \r\n    }, { status: 503 });\r\n  }\r\n\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const supabase = await createClient();\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const { message } = body;\r\n\r\n    if (!message || typeof message !== 'string') {\r\n      return NextResponse.json({ \r\n        error: 'Message is required' \r\n      }, { status: 400 });\r\n    }\r\n\r\n    // Sanitize input\r\n    const sanitizedMessage = sanitizeUserInput(message);\r\n\r\n    logAIFeatureUsage('ai_coach', user.id, { messageLength: message.length });\r\n\r\n    // Fetch context for the coach\r\n    const context = await buildCoachContext(supabase, user.id);\r\n\r\n    // Fetch recent conversation history\r\n    const { data: chatHistory } = await supabase\r\n      .from('ai_chat_history')\r\n      .select('role, message')\r\n      .eq('user_id', user.id)\r\n      .order('created_at', { ascending: false })\r\n      .limit(10);\r\n\r\n    const conversationHistory: ConversationMessage[] = (chatHistory || [])\r\n      .reverse()\r\n      .map(msg => ({\r\n        role: msg.role as 'user' | 'assistant',\r\n        message: msg.message,\r\n      }));\r\n\r\n    // Get coach response\r\n    const response = await processCoachMessage(\r\n      user.id,\r\n      sanitizedMessage,\r\n      context,\r\n      conversationHistory\r\n    );\r\n\r\n    // Save both messages to history\r\n    const messagesToSave = [\r\n      {\r\n        user_id: user.id,\r\n        role: 'user',\r\n        message: sanitizedMessage,\r\n        context_snapshot: {\r\n          taskCount: context.recentTasks.length,\r\n          focusMinutes: context.recentFocus.totalMinutes,\r\n          goalCount: context.currentGoals.length,\r\n        },\r\n      },\r\n      {\r\n        user_id: user.id,\r\n        role: 'assistant',\r\n        message: response,\r\n        context_snapshot: null,\r\n      },\r\n    ];\r\n\r\n    await supabase.from('ai_chat_history').insert(messagesToSave);\r\n\r\n    const latency = Date.now() - startTime;\r\n\r\n    logAIEvent('coach_response_sent', {\r\n      userId: user.id,\r\n      latencyMs: latency,\r\n      responseLength: response.length,\r\n    });\r\n\r\n    return NextResponse.json({\r\n      response,\r\n      latencyMs: latency,\r\n    });\r\n\r\n  } catch (error) {\r\n    const latency = Date.now() - startTime;\r\n    logAIError(error as Error, { \r\n      operation: 'ai_coach',\r\n      latencyMs: latency,\r\n    });\r\n\r\n    return NextResponse.json({ \r\n      error: 'Failed to get coach response',\r\n      latencyMs: latency,\r\n    }, { status: 500 });\r\n  }\r\n}\r\n\r\n/**\r\n * Builds context for the AI coach from user data.\r\n */\r\nasync function buildCoachContext(\r\n  supabase: Awaited<ReturnType<typeof createClient>>,\r\n  userId: string\r\n): Promise<CoachContext> {\r\n  // Fetch recent data\r\n  const [tasksRes, focusRes, goalsRes, planRes] = await Promise.all([\r\n    supabase.from('tasks').select('*').eq('user_id', userId)\r\n      .order('created_at', { ascending: false }).limit(20),\r\n    supabase.from('focus_sessions').select('*').eq('user_id', userId)\r\n      .order('created_at', { ascending: false }).limit(10),\r\n    supabase.from('goals').select('*').eq('user_id', userId).eq('status', 'active'),\r\n    supabase.from('ai_plans').select('status, schedule').eq('user_id', userId)\r\n      .eq('plan_date', new Date().toISOString().split('T')[0]).single(),\r\n  ]);\r\n\r\n  const tasks = tasksRes.data || [];\r\n  const focusSessions = focusRes.data || [];\r\n  const goals = goalsRes.data || [];\r\n  const todaysPlan = planRes.data;\r\n\r\n  // Map tasks to expected format\r\n  const recentTasks = tasks.map(t => ({\r\n    id: t.id,\r\n    title: t.title,\r\n    description: t.description || undefined,\r\n    priority: t.priority as 'high' | 'medium' | 'low',\r\n    timeEstimate: t.time_estimate || 30,\r\n    completed: t.completed || false,\r\n    createdAt: new Date(t.created_at),\r\n    category: t.category || undefined,\r\n    dueDate: t.due_date || undefined,\r\n    focusMode: t.focus_mode || false,\r\n  }));\r\n\r\n  // Map goals\r\n  const currentGoals = goals.map(g => ({\r\n    id: g.id,\r\n    title: g.title,\r\n    description: g.description || undefined,\r\n    category: g.category,\r\n    targetDate: g.target_date || undefined,\r\n    createdAt: new Date(g.created_at),\r\n    milestones: [],\r\n    progress: g.progress || 0,\r\n    status: g.status as 'active' | 'completed' | 'paused',\r\n    color: g.color,\r\n  }));\r\n\r\n  // Calculate focus stats\r\n  const totalFocusMinutes = focusSessions.reduce((sum, s) => sum + (s.duration || 0), 0);\r\n\r\n  // Build plan info if exists\r\n  let todaysPlanInfo: CoachContext['todaysPlan'] = undefined;\r\n  if (todaysPlan) {\r\n    const schedule = todaysPlan.schedule as any[] || [];\r\n    const completedInPlan = schedule.filter((item: any) => {\r\n      const matchingTask = tasks.find(t => t.id === item.taskId);\r\n      return matchingTask?.completed;\r\n    }).length;\r\n\r\n    todaysPlanInfo = {\r\n      accepted: todaysPlan.status === 'accepted',\r\n      tasksCompleted: completedInPlan,\r\n      totalTasks: schedule.filter((item: any) => item.type === 'work').length,\r\n    };\r\n  }\r\n\r\n  return {\r\n    recentTasks,\r\n    recentFocus: {\r\n      totalMinutes: totalFocusMinutes,\r\n      sessionCount: focusSessions.length,\r\n    },\r\n    currentGoals,\r\n    todaysPlan: todaysPlanInfo,\r\n  };\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}