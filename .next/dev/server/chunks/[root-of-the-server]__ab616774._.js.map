{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/logger.ts"],"sourcesContent":["/**\r\n * AI System Logger\r\n * Provides structured logging for AI operations, useful for debugging and monitoring.\r\n */\r\n\r\ninterface LogEntry {\r\n  timestamp: string;\r\n  event: string;\r\n  data: Record<string, unknown>;\r\n}\r\n\r\ninterface ErrorEntry {\r\n  timestamp: string;\r\n  error: {\r\n    message: string;\r\n    stack?: string;\r\n  };\r\n  context: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Logs an AI-related event with structured data.\r\n * In development, logs to console. In production, can be extended to send to monitoring services.\r\n */\r\nexport function logAIEvent(event: string, data: Record<string, unknown>): void {\r\n  const logEntry: LogEntry = {\r\n    timestamp: new Date().toISOString(),\r\n    event,\r\n    data,\r\n  };\r\n\r\n  // Development: console logging\r\n  if (process.env.NODE_ENV === 'development') {\r\n    console.log('[AI]', JSON.stringify(logEntry, null, 2));\r\n  } else {\r\n    // Production: structured logging (can be picked up by Vercel logs, etc.)\r\n    console.log('[AI]', JSON.stringify(logEntry));\r\n  }\r\n\r\n  // TODO: Add integration with monitoring service (e.g., Sentry, LogRocket, Datadog)\r\n  // Example:\r\n  // if (process.env.NODE_ENV === 'production' && typeof window === 'undefined') {\r\n  //   sendToMonitoringService(logEntry);\r\n  // }\r\n}\r\n\r\n/**\r\n * Logs an AI-related error with context.\r\n * Always logs to console.error and can be extended for error tracking services.\r\n */\r\nexport function logAIError(error: Error, context: Record<string, unknown>): void {\r\n  const errorEntry: ErrorEntry = {\r\n    timestamp: new Date().toISOString(),\r\n    error: {\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    context,\r\n  };\r\n\r\n  console.error('[AI ERROR]', JSON.stringify(errorEntry, null, 2));\r\n\r\n  // TODO: Add integration with error tracking service\r\n  // Example:\r\n  // if (process.env.NODE_ENV === 'production') {\r\n  //   Sentry.captureException(error, { extra: context });\r\n  // }\r\n}\r\n\r\n/**\r\n * Logs metrics for AI operations (latency, token usage, etc.)\r\n */\r\nexport function logAIMetrics(operation: string, metrics: {\r\n  latencyMs: number;\r\n  promptTokens?: number;\r\n  completionTokens?: number;\r\n  success: boolean;\r\n  userId?: string;\r\n}): void {\r\n  logAIEvent('ai_metrics', {\r\n    operation,\r\n    ...metrics,\r\n  });\r\n}\r\n\r\n/**\r\n * Logs when an AI feature is used\r\n */\r\nexport function logAIFeatureUsage(feature: string, userId: string, metadata?: Record<string, unknown>): void {\r\n  logAIEvent('ai_feature_usage', {\r\n    feature,\r\n    userId,\r\n    ...metadata,\r\n  });\r\n}\r\n\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;AAqBM,SAAS,WAAW,KAAa,EAAE,IAA6B;IACrE,MAAM,WAAqB;QACzB,WAAW,IAAI,OAAO,WAAW;QACjC;QACA;IACF;IAEA,+BAA+B;IAC/B,wCAA4C;QAC1C,QAAQ,GAAG,CAAC,QAAQ,KAAK,SAAS,CAAC,UAAU,MAAM;IACrD;;AAKA,mFAAmF;AACnF,WAAW;AACX,gFAAgF;AAChF,uCAAuC;AACvC,IAAI;AACN;AAMO,SAAS,WAAW,KAAY,EAAE,OAAgC;IACvE,MAAM,aAAyB;QAC7B,WAAW,IAAI,OAAO,WAAW;QACjC,OAAO;YACL,SAAS,MAAM,OAAO;YACtB,OAAO,MAAM,KAAK;QACpB;QACA;IACF;IAEA,QAAQ,KAAK,CAAC,cAAc,KAAK,SAAS,CAAC,YAAY,MAAM;AAE7D,oDAAoD;AACpD,WAAW;AACX,+CAA+C;AAC/C,wDAAwD;AACxD,IAAI;AACN;AAKO,SAAS,aAAa,SAAiB,EAAE,OAM/C;IACC,WAAW,cAAc;QACvB;QACA,GAAG,OAAO;IACZ;AACF;AAKO,SAAS,kBAAkB,OAAe,EAAE,MAAc,EAAE,QAAkC;IACnG,WAAW,oBAAoB;QAC7B;QACA;QACA,GAAG,QAAQ;IACb;AACF"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/gemini-client.ts"],"sourcesContent":["import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from '@google/generative-ai';\r\nimport type { GeminiMessage, GeminiResponse } from './types';\r\nimport { logAIEvent, logAIError } from './logger';\r\n\r\n// Initialize Gemini client\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');\r\n\r\n// Safety settings to allow productivity-related content\r\nconst safetySettings = [\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_HARASSMENT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n];\r\n\r\n/**\r\n * Calls the Gemini API with the provided prompt and optional conversation history.\r\n * \r\n * @param prompt - The user's message or request\r\n * @param systemInstruction - Optional system-level instruction for the model\r\n * @param conversationHistory - Optional array of previous messages for context\r\n * @returns GeminiResponse with text and usage information\r\n */\r\nexport async function callGemini(\r\n  prompt: string,\r\n  systemInstruction?: string,\r\n  conversationHistory?: GeminiMessage[]\r\n): Promise<GeminiResponse> {\r\n  if (!process.env.GEMINI_API_KEY) {\r\n    throw new Error('GEMINI_API_KEY environment variable is not set');\r\n  }\r\n\r\n  const startTime = Date.now();\r\n  \r\n  try {\r\n    const model = genAI.getGenerativeModel({\r\n      model: 'gemini-1.5-flash', // Using flash for faster responses, can upgrade to pro\r\n      systemInstruction: systemInstruction,\r\n      safetySettings,\r\n      generationConfig: {\r\n        temperature: 0.7,\r\n        topP: 0.95,\r\n        topK: 40,\r\n        maxOutputTokens: 2048,\r\n      },\r\n    });\r\n\r\n    let result;\r\n    \r\n    if (conversationHistory && conversationHistory.length > 0) {\r\n      // Use chat mode for conversations\r\n      const chat = model.startChat({\r\n        history: conversationHistory.map(msg => ({\r\n          role: msg.role,\r\n          parts: [{ text: msg.parts }],\r\n        })),\r\n      });\r\n      result = await chat.sendMessage(prompt);\r\n    } else {\r\n      // Use simple generation for single prompts\r\n      result = await model.generateContent(prompt);\r\n    }\r\n\r\n    const response = result.response;\r\n    const text = response.text();\r\n    const latency = Date.now() - startTime;\r\n\r\n    logAIEvent('gemini_call_success', {\r\n      latencyMs: latency,\r\n      promptLength: prompt.length,\r\n      responseLength: text.length,\r\n      promptTokens: response.usageMetadata?.promptTokenCount || 0,\r\n      completionTokens: response.usageMetadata?.candidatesTokenCount || 0,\r\n    });\r\n\r\n    return {\r\n      text,\r\n      usage: {\r\n        promptTokens: response.usageMetadata?.promptTokenCount || 0,\r\n        completionTokens: response.usageMetadata?.candidatesTokenCount || 0,\r\n      },\r\n    };\r\n  } catch (error) {\r\n    const latency = Date.now() - startTime;\r\n    logAIError(error as Error, { \r\n      operation: 'callGemini',\r\n      latencyMs: latency,\r\n      promptLength: prompt.length,\r\n    });\r\n    throw new Error(`Gemini API call failed: ${(error as Error).message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Calls Gemini expecting a JSON response. Automatically parses and validates the output.\r\n * \r\n * @param prompt - The prompt requesting JSON output\r\n * @param systemInstruction - Optional system instruction\r\n * @returns Parsed JSON object\r\n */\r\nexport async function callGeminiJSON<T>(\r\n  prompt: string,\r\n  systemInstruction?: string\r\n): Promise<T> {\r\n  const response = await callGemini(prompt, systemInstruction);\r\n  \r\n  try {\r\n    // Try to extract JSON from the response\r\n    let jsonText = response.text.trim();\r\n    \r\n    // Handle markdown code blocks\r\n    if (jsonText.startsWith('```json')) {\r\n      jsonText = jsonText.slice(7);\r\n    } else if (jsonText.startsWith('```')) {\r\n      jsonText = jsonText.slice(3);\r\n    }\r\n    if (jsonText.endsWith('```')) {\r\n      jsonText = jsonText.slice(0, -3);\r\n    }\r\n    \r\n    jsonText = jsonText.trim();\r\n    \r\n    const parsed = JSON.parse(jsonText) as T;\r\n    return parsed;\r\n  } catch (parseError) {\r\n    logAIError(parseError as Error, {\r\n      operation: 'callGeminiJSON',\r\n      rawResponse: response.text.slice(0, 500),\r\n    });\r\n    throw new Error(`Failed to parse Gemini response as JSON: ${(parseError as Error).message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Validates that the Gemini API key is configured.\r\n */\r\nexport function isGeminiConfigured(): boolean {\r\n  return !!process.env.GEMINI_API_KEY;\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AAEA;;;AAEA,2BAA2B;AAC3B,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI;AAEnE,wDAAwD;AACxD,MAAM,iBAAiB;IACrB;QACE,UAAU,gLAAY,CAAC,wBAAwB;QAC/C,WAAW,sLAAkB,CAAC,sBAAsB;IACtD;IACA;QACE,UAAU,gLAAY,CAAC,yBAAyB;QAChD,WAAW,sLAAkB,CAAC,sBAAsB;IACtD;IACA;QACE,UAAU,gLAAY,CAAC,+BAA+B;QACtD,WAAW,sLAAkB,CAAC,sBAAsB;IACtD;IACA;QACE,UAAU,gLAAY,CAAC,+BAA+B;QACtD,WAAW,sLAAkB,CAAC,sBAAsB;IACtD;CACD;AAUM,eAAe,WACpB,MAAc,EACd,iBAA0B,EAC1B,mBAAqC;IAErC,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,YAAY,KAAK,GAAG;IAE1B,IAAI;QACF,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YACrC,OAAO;YACP,mBAAmB;YACnB;YACA,kBAAkB;gBAChB,aAAa;gBACb,MAAM;gBACN,MAAM;gBACN,iBAAiB;YACnB;QACF;QAEA,IAAI;QAEJ,IAAI,uBAAuB,oBAAoB,MAAM,GAAG,GAAG;YACzD,kCAAkC;YAClC,MAAM,OAAO,MAAM,SAAS,CAAC;gBAC3B,SAAS,oBAAoB,GAAG,CAAC,CAAA,MAAO,CAAC;wBACvC,MAAM,IAAI,IAAI;wBACd,OAAO;4BAAC;gCAAE,MAAM,IAAI,KAAK;4BAAC;yBAAE;oBAC9B,CAAC;YACH;YACA,SAAS,MAAM,KAAK,WAAW,CAAC;QAClC,OAAO;YACL,2CAA2C;YAC3C,SAAS,MAAM,MAAM,eAAe,CAAC;QACvC;QAEA,MAAM,WAAW,OAAO,QAAQ;QAChC,MAAM,OAAO,SAAS,IAAI;QAC1B,MAAM,UAAU,KAAK,GAAG,KAAK;QAE7B,IAAA,mIAAU,EAAC,uBAAuB;YAChC,WAAW;YACX,cAAc,OAAO,MAAM;YAC3B,gBAAgB,KAAK,MAAM;YAC3B,cAAc,SAAS,aAAa,EAAE,oBAAoB;YAC1D,kBAAkB,SAAS,aAAa,EAAE,wBAAwB;QACpE;QAEA,OAAO;YACL;YACA,OAAO;gBACL,cAAc,SAAS,aAAa,EAAE,oBAAoB;gBAC1D,kBAAkB,SAAS,aAAa,EAAE,wBAAwB;YACpE;QACF;IACF,EAAE,OAAO,OAAO;QACd,MAAM,UAAU,KAAK,GAAG,KAAK;QAC7B,IAAA,mIAAU,EAAC,OAAgB;YACzB,WAAW;YACX,WAAW;YACX,cAAc,OAAO,MAAM;QAC7B;QACA,MAAM,IAAI,MAAM,CAAC,wBAAwB,EAAE,AAAC,MAAgB,OAAO,EAAE;IACvE;AACF;AASO,eAAe,eACpB,MAAc,EACd,iBAA0B;IAE1B,MAAM,WAAW,MAAM,WAAW,QAAQ;IAE1C,IAAI;QACF,wCAAwC;QACxC,IAAI,WAAW,SAAS,IAAI,CAAC,IAAI;QAEjC,8BAA8B;QAC9B,IAAI,SAAS,UAAU,CAAC,YAAY;YAClC,WAAW,SAAS,KAAK,CAAC;QAC5B,OAAO,IAAI,SAAS,UAAU,CAAC,QAAQ;YACrC,WAAW,SAAS,KAAK,CAAC;QAC5B;QACA,IAAI,SAAS,QAAQ,CAAC,QAAQ;YAC5B,WAAW,SAAS,KAAK,CAAC,GAAG,CAAC;QAChC;QAEA,WAAW,SAAS,IAAI;QAExB,MAAM,SAAS,KAAK,KAAK,CAAC;QAC1B,OAAO;IACT,EAAE,OAAO,YAAY;QACnB,IAAA,mIAAU,EAAC,YAAqB;YAC9B,WAAW;YACX,aAAa,SAAS,IAAI,CAAC,KAAK,CAAC,GAAG;QACtC;QACA,MAAM,IAAI,MAAM,CAAC,yCAAyC,EAAE,AAAC,WAAqB,OAAO,EAAE;IAC7F;AACF;AAKO,SAAS;IACd,OAAO,CAAC,CAAC,QAAQ,GAAG,CAAC,cAAc;AACrC"}},
    {"offset": {"line": 268, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/prompt-builder.ts"],"sourcesContent":["import type { ScheduleContext, Task, Goal, UserAIProfile, DailyAggregate } from './types';\r\n\r\n/**\r\n * Builds a prompt for generating a daily schedule using Gemini.\r\n * Includes user profile, recent performance data, and current tasks.\r\n */\r\nexport function buildSchedulePrompt(context: ScheduleContext): string {\r\n  const { user, profile, recentAggregates, todaysTasks, activeGoals } = context;\r\n\r\n  // Compute summary stats from recent aggregates\r\n  const avgFocusTime = recentAggregates.length > 0\r\n    ? recentAggregates.reduce((sum, a) => sum + (a.total_focus_minutes || 0), 0) / recentAggregates.length\r\n    : 0;\r\n  const avgCompletionRate = recentAggregates.length > 0\r\n    ? recentAggregates.reduce((sum, a) => sum + (a.completion_rate || 0), 0) / recentAggregates.length\r\n    : 0;\r\n  const avgDailyRating = recentAggregates.filter(a => a.daily_rating).length > 0\r\n    ? recentAggregates.filter(a => a.daily_rating).reduce((sum, a) => sum + (a.daily_rating || 0), 0) / recentAggregates.filter(a => a.daily_rating).length\r\n    : null;\r\n\r\n  // Format productive hours\r\n  const productiveHoursStr = profile.most_productive_hours.length > 0\r\n    ? profile.most_productive_hours.map(h => `${h}:00`).join(', ')\r\n    : 'Not yet determined';\r\n\r\n  // Format distraction times\r\n  const distractionTimesStr = profile.common_distraction_times.length > 0\r\n    ? profile.common_distraction_times.map(h => `${h}:00`).join(', ')\r\n    : 'None identified';\r\n\r\n  // Sort tasks by priority\r\n  const sortedTasks = [...todaysTasks].sort((a, b) => {\r\n    const priorityOrder = { high: 0, medium: 1, low: 2 };\r\n    return priorityOrder[a.priority] - priorityOrder[b.priority];\r\n  });\r\n\r\n  return `You are an AI productivity coach helping ${user.name || 'the user'} plan their day.\r\n\r\n**User's Personalization Profile:**\r\n- Optimal focus duration: ${profile.optimal_focus_duration} minutes\r\n- Preferred work hours: ${profile.preferred_work_start_hour}:00 - ${profile.preferred_work_end_hour}:00\r\n- Preferred break duration: ${profile.preferred_break_duration} minutes\r\n- Most productive hours: ${productiveHoursStr}\r\n- Common distraction times: ${distractionTimesStr}\r\n\r\n**Recent Performance (last ${recentAggregates.length} days):**\r\n- Average focus time: ${Math.round(avgFocusTime)} minutes/day\r\n- Average task completion rate: ${(avgCompletionRate * 100).toFixed(1)}%\r\n- Plan acceptance rate: ${((profile.avg_plan_acceptance_rate || 0) * 100).toFixed(1)}%\r\n${avgDailyRating ? `- Average daily satisfaction: ${avgDailyRating.toFixed(1)}/10` : ''}\r\n\r\n**Today's Tasks (${sortedTasks.length} total):**\r\n${sortedTasks.slice(0, 10).map((t, i) =>\r\n    `${i + 1}. [${t.priority.toUpperCase()}] ${t.title} (${t.timeEstimate} min)${t.dueDate ? ` - Due: ${t.dueDate}` : ''}${t.category ? ` [${t.category}]` : ''}`\r\n  ).join('\\n')}\r\n${sortedTasks.length > 10 ? `\\n... and ${sortedTasks.length - 10} more tasks` : ''}\r\n${sortedTasks.length === 0 ? 'No tasks scheduled yet. Suggest a productive day structure.' : ''}\r\n\r\n**Active Goals:**\r\n${activeGoals.slice(0, 5).map(g => `- ${g.title} (${g.progress}% complete)${g.targetDate ? ` - Target: ${g.targetDate}` : ''}`).join('\\n')}\r\n${activeGoals.length === 0 ? 'No active goals set.' : ''}\r\n\r\n**Current Time:** ${context.currentTime}\r\n\r\n**Instructions:**\r\n1. Create a realistic schedule for today starting from the current time\r\n2. Prioritize high-priority tasks during the user's most productive hours (${productiveHoursStr})\r\n3. Include breaks of ${profile.preferred_break_duration} minutes after every ${profile.optimal_focus_duration} minutes of work\r\n4. Avoid scheduling demanding tasks during distraction-prone times (${distractionTimesStr})\r\n5. Keep focus blocks around ${profile.optimal_focus_duration} minutes\r\n6. Leave some buffer time between tasks\r\n7. Consider task due dates when prioritizing\r\n\r\nReturn a JSON object with this exact structure:\r\n{\r\n  \"schedule\": [\r\n    {\r\n      \"time\": \"HH:MM\",\r\n      \"duration\": <minutes as number>,\r\n      \"task\": \"<task description>\",\r\n      \"priority\": \"high\" | \"medium\" | \"low\",\r\n      \"taskId\": \"<task id if matching a user task, or null>\",\r\n      \"type\": \"work\" | \"break\" | \"meeting\"\r\n    }\r\n  ],\r\n  \"explanation\": \"<2-3 sentence personalized explanation of why this schedule is optimized for the user>\",\r\n  \"reasoning\": {\r\n    \"focusHours\": [\"<hours where deep work is scheduled>\"],\r\n    \"breakStrategy\": \"<brief explanation of break placement>\",\r\n    \"prioritization\": \"<brief explanation of task order>\"\r\n  }\r\n}\r\n\r\nImportant: Ensure the JSON is valid and parseable.`;\r\n}\r\n\r\n/**\r\n * Builds a system instruction for schedule generation.\r\n */\r\nexport function getScheduleSystemInstruction(): string {\r\n  return `You are an expert productivity coach AI. Your role is to create personalized daily schedules that maximize the user's productivity while maintaining work-life balance.\r\n\r\nKey principles:\r\n- Always respect the user's preferred work hours\r\n- Schedule high-priority and cognitively demanding tasks during peak productivity hours\r\n- Include regular breaks to prevent burnout\r\n- Be realistic about time estimates\r\n- Consider task dependencies and energy levels throughout the day\r\n- Always respond with valid, parseable JSON matching the requested schema\r\n- Keep explanations concise but personalized`;\r\n}\r\n\r\n/**\r\n * Builds a prompt for the AI Coach conversation feature.\r\n */\r\nexport function buildCoachPrompt(\r\n  userMessage: string,\r\n  context: {\r\n    recentTasks: Task[];\r\n    recentFocus: { totalMinutes: number; sessionCount?: number };\r\n    currentGoals: Goal[];\r\n    todaysPlan?: { accepted: boolean; tasksCompleted: number; totalTasks: number };\r\n  },\r\n  conversationHistory: { role: string; message: string }[]\r\n): string {\r\n  const completedTasks = context.recentTasks.filter(t => t.completed).length;\r\n  const totalTasks = context.recentTasks.length;\r\n  const completionRate = totalTasks > 0 ? (completedTasks / totalTasks * 100).toFixed(0) : 0;\r\n\r\n  return `The user just said: \"${userMessage}\"\r\n\r\n**Current User Context:**\r\n- Recent tasks: ${totalTasks} tasks (${completedTasks} completed, ${completionRate}% completion rate)\r\n- Recent focus time: ${context.recentFocus.totalMinutes} minutes${context.recentFocus.sessionCount ? ` across ${context.recentFocus.sessionCount} sessions` : ''}\r\n- Active goals: ${context.currentGoals.length} goals in progress\r\n${context.todaysPlan ? `- Today's plan: ${context.todaysPlan.accepted ? 'Accepted' : 'Pending'}, ${context.todaysPlan.tasksCompleted}/${context.todaysPlan.totalTasks} tasks done` : ''}\r\n\r\n**Recent Conversation:**\r\n${conversationHistory.slice(-5).map(h => `${h.role === 'user' ? 'User' : 'Coach'}: ${h.message}`).join('\\n')}\r\n\r\nRespond as a supportive, knowledgeable productivity coach. Reference their actual data when relevant. Keep responses concise (2-4 sentences) and actionable.`;\r\n}\r\n\r\n/**\r\n * Builds a system instruction for the AI Coach.\r\n */\r\nexport function getCoachSystemInstruction(): string {\r\n  return `You are a supportive and knowledgeable AI productivity coach called \"Pulse Coach\". Your personality is:\r\n- Encouraging but realistic\r\n- Data-driven (reference user's actual stats when helpful)\r\n- Action-oriented (give specific, practical advice)\r\n- Empathetic (acknowledge challenges and celebrate wins)\r\n\r\nGuidelines:\r\n- Keep responses concise (2-4 sentences max)\r\n- Offer specific suggestions when asked for help\r\n- Celebrate achievements and progress\r\n- Provide gentle accountability when needed\r\n- Never be preachy or condescending\r\n- Reference the user's actual data to personalize advice`;\r\n}\r\n\r\n/**\r\n * Sanitizes user input to prevent prompt injection.\r\n */\r\nexport function sanitizeUserInput(input: string): string {\r\n  // Remove potential instruction override attempts\r\n  let sanitized = input\r\n    .replace(/system:/gi, '[filtered]')\r\n    .replace(/instruction:/gi, '[filtered]')\r\n    .replace(/ignore previous/gi, '[filtered]')\r\n    .replace(/disregard/gi, '[filtered]');\r\n  \r\n  // Limit length\r\n  if (sanitized.length > 2000) {\r\n    sanitized = sanitized.slice(0, 2000) + '...';\r\n  }\r\n  \r\n  return sanitized;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/schedule-generator.ts"],"sourcesContent":["import { callGeminiJSON } from './gemini-client';\r\nimport { buildSchedulePrompt, getScheduleSystemInstruction } from './prompt-builder';\r\nimport type { AISchedule, ScheduleContext, ScheduleItem } from './types';\r\nimport { logAIEvent, logAIError, logAIMetrics } from './logger';\r\n\r\ninterface GeminiScheduleResponse {\r\n  schedule: ScheduleItem[];\r\n  explanation: string;\r\n  reasoning: {\r\n    focusHours?: string[];\r\n    breakStrategy?: string;\r\n    prioritization?: string;\r\n  };\r\n}\r\n\r\n/**\r\n * Generates a daily schedule for a user using Gemini AI.\r\n * \r\n * @param userId - The user's ID\r\n * @param context - The schedule context including user profile, tasks, and history\r\n * @returns An AISchedule object with the generated schedule\r\n */\r\nexport async function generateDailySchedule(\r\n  userId: string,\r\n  context: ScheduleContext\r\n): Promise<AISchedule> {\r\n  const startTime = Date.now();\r\n  \r\n  logAIEvent('schedule_generation_start', {\r\n    userId,\r\n    taskCount: context.todaysTasks.length,\r\n    goalCount: context.activeGoals.length,\r\n    aggregateDays: context.recentAggregates.length,\r\n  });\r\n\r\n  try {\r\n    const prompt = buildSchedulePrompt(context);\r\n    const systemInstruction = getScheduleSystemInstruction();\r\n\r\n    const response = await callGeminiJSON<GeminiScheduleResponse>(\r\n      prompt,\r\n      systemInstruction\r\n    );\r\n\r\n    // Validate response structure\r\n    if (!response.schedule || !Array.isArray(response.schedule)) {\r\n      throw new Error('Invalid schedule format: missing or invalid schedule array');\r\n    }\r\n\r\n    // Validate and clean schedule items\r\n    const validatedSchedule = response.schedule.map((item, index) => {\r\n      // Ensure required fields exist\r\n      if (!item.time || typeof item.duration !== 'number' || !item.task) {\r\n        throw new Error(`Invalid schedule item at index ${index}: missing required fields`);\r\n      }\r\n\r\n      return {\r\n        time: item.time,\r\n        duration: Math.max(5, Math.min(item.duration, 240)), // Clamp between 5 and 240 minutes\r\n        task: item.task,\r\n        priority: ['high', 'medium', 'low'].includes(item.priority) ? item.priority : 'medium',\r\n        taskId: item.taskId || undefined,\r\n        type: ['work', 'break', 'meeting'].includes(item.type) ? item.type : 'work',\r\n      } as ScheduleItem;\r\n    });\r\n\r\n    const latency = Date.now() - startTime;\r\n    \r\n    logAIMetrics('schedule_generation', {\r\n      latencyMs: latency,\r\n      success: true,\r\n      userId,\r\n    });\r\n\r\n    logAIEvent('schedule_generation_success', {\r\n      userId,\r\n      itemCount: validatedSchedule.length,\r\n      latencyMs: latency,\r\n    });\r\n\r\n    return {\r\n      userId,\r\n      schedule: validatedSchedule,\r\n      explanation: response.explanation || 'AI-generated schedule based on your productivity patterns.',\r\n      reasoning: response.reasoning || {},\r\n      modelVersion: 'gemini-1.5-flash',\r\n      generatedAt: new Date(),\r\n    };\r\n  } catch (error) {\r\n    const latency = Date.now() - startTime;\r\n    \r\n    logAIMetrics('schedule_generation', {\r\n      latencyMs: latency,\r\n      success: false,\r\n      userId,\r\n    });\r\n\r\n    logAIError(error as Error, {\r\n      operation: 'generateDailySchedule',\r\n      userId,\r\n      contextSummary: {\r\n        taskCount: context.todaysTasks.length,\r\n        goalCount: context.activeGoals.length,\r\n      },\r\n    });\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Generates a fallback schedule when AI is unavailable.\r\n * Uses simple rule-based logic similar to the original implementation.\r\n */\r\nexport function generateFallbackSchedule(\r\n  userId: string,\r\n  context: ScheduleContext\r\n): AISchedule {\r\n  logAIEvent('fallback_schedule_used', { userId, reason: 'AI unavailable' });\r\n\r\n  const schedule: ScheduleItem[] = [];\r\n  const startHour = context.profile.preferred_work_start_hour || 9;\r\n  const focusDuration = context.profile.optimal_focus_duration || 25;\r\n  const breakDuration = context.profile.preferred_break_duration || 5;\r\n\r\n  // Sort tasks by priority\r\n  const sortedTasks = [...context.todaysTasks]\r\n    .filter(t => !t.completed)\r\n    .sort((a, b) => {\r\n      const priorityOrder = { high: 0, medium: 1, low: 2 };\r\n      return priorityOrder[a.priority] - priorityOrder[b.priority];\r\n    });\r\n\r\n  // Schedule up to 5 tasks with breaks\r\n  let currentHour = startHour;\r\n  let currentMinute = 0;\r\n\r\n  sortedTasks.slice(0, 5).forEach((task, index) => {\r\n    // Add work block\r\n    schedule.push({\r\n      time: `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`,\r\n      duration: Math.min(task.timeEstimate || focusDuration, focusDuration * 2),\r\n      task: task.title,\r\n      priority: task.priority,\r\n      taskId: task.id,\r\n      type: 'work',\r\n    });\r\n\r\n    // Calculate next time slot\r\n    const taskDuration = Math.min(task.timeEstimate || focusDuration, focusDuration * 2);\r\n    currentMinute += taskDuration;\r\n    if (currentMinute >= 60) {\r\n      currentHour += Math.floor(currentMinute / 60);\r\n      currentMinute = currentMinute % 60;\r\n    }\r\n\r\n    // Add break after work (except after last task)\r\n    if (index < Math.min(sortedTasks.length - 1, 4)) {\r\n      schedule.push({\r\n        time: `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`,\r\n        duration: breakDuration,\r\n        task: 'Short break',\r\n        priority: 'low',\r\n        type: 'break',\r\n      });\r\n\r\n      currentMinute += breakDuration;\r\n      if (currentMinute >= 60) {\r\n        currentHour += Math.floor(currentMinute / 60);\r\n        currentMinute = currentMinute % 60;\r\n      }\r\n    }\r\n  });\r\n\r\n  return {\r\n    userId,\r\n    schedule,\r\n    explanation: 'This is a simple schedule based on your task priorities. AI-powered scheduling is currently unavailable.',\r\n    reasoning: {\r\n      prioritization: 'Tasks ordered by priority (high first)',\r\n      breakStrategy: `${breakDuration}-minute breaks between tasks`,\r\n    },\r\n    modelVersion: 'fallback',\r\n    generatedAt: new Date(),\r\n  };\r\n}\r\n\r\n/**\r\n * Attempts to generate a schedule with AI, falling back to rule-based if it fails.\r\n */\r\nexport async function generateScheduleWithFallback(\r\n  userId: string,\r\n  context: ScheduleContext\r\n): Promise<AISchedule> {\r\n  try {\r\n    return await generateDailySchedule(userId, context);\r\n  } catch (error) {\r\n    logAIEvent('schedule_fallback_triggered', {\r\n      userId,\r\n      error: (error as Error).message,\r\n    });\r\n    return generateFallbackSchedule(userId, context);\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AAEA;;;;AAmBO,eAAe,sBACpB,MAAc,EACd,OAAwB;IAExB,MAAM,YAAY,KAAK,GAAG;IAE1B,IAAA,mIAAU,EAAC,6BAA6B;QACtC;QACA,WAAW,QAAQ,WAAW,CAAC,MAAM;QACrC,WAAW,QAAQ,WAAW,CAAC,MAAM;QACrC,eAAe,QAAQ,gBAAgB,CAAC,MAAM;IAChD;IAEA,IAAI;QACF,MAAM,SAAS,IAAA,uJAAmB,EAAC;QACnC,MAAM,oBAAoB,IAAA,gKAA4B;QAEtD,MAAM,WAAW,MAAM,IAAA,iJAAc,EACnC,QACA;QAGF,8BAA8B;QAC9B,IAAI,CAAC,SAAS,QAAQ,IAAI,CAAC,MAAM,OAAO,CAAC,SAAS,QAAQ,GAAG;YAC3D,MAAM,IAAI,MAAM;QAClB;QAEA,oCAAoC;QACpC,MAAM,oBAAoB,SAAS,QAAQ,CAAC,GAAG,CAAC,CAAC,MAAM;YACrD,+BAA+B;YAC/B,IAAI,CAAC,KAAK,IAAI,IAAI,OAAO,KAAK,QAAQ,KAAK,YAAY,CAAC,KAAK,IAAI,EAAE;gBACjE,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,MAAM,yBAAyB,CAAC;YACpF;YAEA,OAAO;gBACL,MAAM,KAAK,IAAI;gBACf,UAAU,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,KAAK,QAAQ,EAAE;gBAC9C,MAAM,KAAK,IAAI;gBACf,UAAU;oBAAC;oBAAQ;oBAAU;iBAAM,CAAC,QAAQ,CAAC,KAAK,QAAQ,IAAI,KAAK,QAAQ,GAAG;gBAC9E,QAAQ,KAAK,MAAM,IAAI;gBACvB,MAAM;oBAAC;oBAAQ;oBAAS;iBAAU,CAAC,QAAQ,CAAC,KAAK,IAAI,IAAI,KAAK,IAAI,GAAG;YACvE;QACF;QAEA,MAAM,UAAU,KAAK,GAAG,KAAK;QAE7B,IAAA,qIAAY,EAAC,uBAAuB;YAClC,WAAW;YACX,SAAS;YACT;QACF;QAEA,IAAA,mIAAU,EAAC,+BAA+B;YACxC;YACA,WAAW,kBAAkB,MAAM;YACnC,WAAW;QACb;QAEA,OAAO;YACL;YACA,UAAU;YACV,aAAa,SAAS,WAAW,IAAI;YACrC,WAAW,SAAS,SAAS,IAAI,CAAC;YAClC,cAAc;YACd,aAAa,IAAI;QACnB;IACF,EAAE,OAAO,OAAO;QACd,MAAM,UAAU,KAAK,GAAG,KAAK;QAE7B,IAAA,qIAAY,EAAC,uBAAuB;YAClC,WAAW;YACX,SAAS;YACT;QACF;QAEA,IAAA,mIAAU,EAAC,OAAgB;YACzB,WAAW;YACX;YACA,gBAAgB;gBACd,WAAW,QAAQ,WAAW,CAAC,MAAM;gBACrC,WAAW,QAAQ,WAAW,CAAC,MAAM;YACvC;QACF;QAEA,MAAM;IACR;AACF;AAMO,SAAS,yBACd,MAAc,EACd,OAAwB;IAExB,IAAA,mIAAU,EAAC,0BAA0B;QAAE;QAAQ,QAAQ;IAAiB;IAExE,MAAM,WAA2B,EAAE;IACnC,MAAM,YAAY,QAAQ,OAAO,CAAC,yBAAyB,IAAI;IAC/D,MAAM,gBAAgB,QAAQ,OAAO,CAAC,sBAAsB,IAAI;IAChE,MAAM,gBAAgB,QAAQ,OAAO,CAAC,wBAAwB,IAAI;IAElE,yBAAyB;IACzB,MAAM,cAAc;WAAI,QAAQ,WAAW;KAAC,CACzC,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,SAAS,EACxB,IAAI,CAAC,CAAC,GAAG;QACR,MAAM,gBAAgB;YAAE,MAAM;YAAG,QAAQ;YAAG,KAAK;QAAE;QACnD,OAAO,aAAa,CAAC,EAAE,QAAQ,CAAC,GAAG,aAAa,CAAC,EAAE,QAAQ,CAAC;IAC9D;IAEF,qCAAqC;IACrC,IAAI,cAAc;IAClB,IAAI,gBAAgB;IAEpB,YAAY,KAAK,CAAC,GAAG,GAAG,OAAO,CAAC,CAAC,MAAM;QACrC,iBAAiB;QACjB,SAAS,IAAI,CAAC;YACZ,MAAM,GAAG,YAAY,QAAQ,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,cAAc,QAAQ,GAAG,QAAQ,CAAC,GAAG,MAAM;YAC/F,UAAU,KAAK,GAAG,CAAC,KAAK,YAAY,IAAI,eAAe,gBAAgB;YACvE,MAAM,KAAK,KAAK;YAChB,UAAU,KAAK,QAAQ;YACvB,QAAQ,KAAK,EAAE;YACf,MAAM;QACR;QAEA,2BAA2B;QAC3B,MAAM,eAAe,KAAK,GAAG,CAAC,KAAK,YAAY,IAAI,eAAe,gBAAgB;QAClF,iBAAiB;QACjB,IAAI,iBAAiB,IAAI;YACvB,eAAe,KAAK,KAAK,CAAC,gBAAgB;YAC1C,gBAAgB,gBAAgB;QAClC;QAEA,gDAAgD;QAChD,IAAI,QAAQ,KAAK,GAAG,CAAC,YAAY,MAAM,GAAG,GAAG,IAAI;YAC/C,SAAS,IAAI,CAAC;gBACZ,MAAM,GAAG,YAAY,QAAQ,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,cAAc,QAAQ,GAAG,QAAQ,CAAC,GAAG,MAAM;gBAC/F,UAAU;gBACV,MAAM;gBACN,UAAU;gBACV,MAAM;YACR;YAEA,iBAAiB;YACjB,IAAI,iBAAiB,IAAI;gBACvB,eAAe,KAAK,KAAK,CAAC,gBAAgB;gBAC1C,gBAAgB,gBAAgB;YAClC;QACF;IACF;IAEA,OAAO;QACL;QACA;QACA,aAAa;QACb,WAAW;YACT,gBAAgB;YAChB,eAAe,GAAG,cAAc,4BAA4B,CAAC;QAC/D;QACA,cAAc;QACd,aAAa,IAAI;IACnB;AACF;AAKO,eAAe,6BACpB,MAAc,EACd,OAAwB;IAExB,IAAI;QACF,OAAO,MAAM,sBAAsB,QAAQ;IAC7C,EAAE,OAAO,OAAO;QACd,IAAA,mIAAU,EAAC,+BAA+B;YACxC;YACA,OAAO,AAAC,MAAgB,OAAO;QACjC;QACA,OAAO,yBAAyB,QAAQ;IAC1C;AACF"}},
    {"offset": {"line": 588, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/lib/ai/types.ts"],"sourcesContent":["// AI System TypeScript Types\r\n\r\nexport interface GeminiMessage {\r\n  role: 'user' | 'model';\r\n  parts: string;\r\n}\r\n\r\nexport interface GeminiResponse {\r\n  text: string;\r\n  usage?: {\r\n    promptTokens: number;\r\n    completionTokens: number;\r\n  };\r\n}\r\n\r\nexport interface ScheduleItem {\r\n  time: string; // HH:MM format\r\n  duration: number; // minutes\r\n  task: string;\r\n  priority: 'high' | 'medium' | 'low';\r\n  taskId?: string;\r\n  type: 'work' | 'break' | 'meeting';\r\n}\r\n\r\nexport interface AISchedule {\r\n  userId: string;\r\n  schedule: ScheduleItem[];\r\n  explanation: string;\r\n  reasoning: {\r\n    focusHours?: string[];\r\n    breakStrategy?: string;\r\n    prioritization?: string;\r\n  };\r\n  modelVersion: string;\r\n  generatedAt: Date;\r\n}\r\n\r\nexport interface DailyAggregate {\r\n  id: string;\r\n  user_id: string;\r\n  date: string;\r\n  total_focus_minutes: number;\r\n  focus_session_count: number;\r\n  avg_focus_duration: number;\r\n  longest_focus_session: number;\r\n  tasks_completed: number;\r\n  tasks_created: number;\r\n  high_priority_completed: number;\r\n  completion_rate: number;\r\n  distraction_count: number;\r\n  total_distraction_minutes: number;\r\n  hourly_activity: number[];\r\n  mood_score: number | null;\r\n  daily_rating: number | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface UserAIProfile {\r\n  id: string;\r\n  user_id: string;\r\n  optimal_focus_duration: number;\r\n  preferred_work_start_hour: number;\r\n  preferred_work_end_hour: number;\r\n  preferred_break_duration: number;\r\n  hourly_performance_scores: number[];\r\n  most_productive_hours: number[];\r\n  common_distraction_times: number[];\r\n  total_plans_generated: number;\r\n  total_plans_accepted: number;\r\n  total_plans_rejected: number;\r\n  avg_plan_acceptance_rate: number;\r\n  last_analyzed_date: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface AIPlan {\r\n  id: string;\r\n  user_id: string;\r\n  plan_date: string;\r\n  schedule: ScheduleItem[];\r\n  explanation: string;\r\n  reasoning: Record<string, unknown>;\r\n  generated_at: string;\r\n  model_version: string;\r\n  status: 'pending' | 'accepted' | 'rejected' | 'edited' | 'expired';\r\n  accepted_at: string | null;\r\n  rejected_at: string | null;\r\n  original_schedule: ScheduleItem[] | null;\r\n  edit_count: number;\r\n  last_edited_at: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface PlanFeedbackEvent {\r\n  id: string;\r\n  plan_id: string;\r\n  user_id: string;\r\n  event_type: 'accepted' | 'rejected' | 'edited' | 'task_completed' | 'task_skipped';\r\n  event_data: Record<string, unknown> | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface ChatMessage {\r\n  id: string;\r\n  user_id: string;\r\n  role: 'user' | 'assistant';\r\n  message: string;\r\n  context_snapshot: Record<string, unknown> | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface ScheduleContext {\r\n  user: {\r\n    name: string;\r\n    timezone: string;\r\n  };\r\n  profile: UserAIProfile;\r\n  recentAggregates: DailyAggregate[];\r\n  todaysTasks: Task[];\r\n  activeGoals: Goal[];\r\n  currentTime: string;\r\n}\r\n\r\n// Re-export types from store for convenience\r\nexport interface Task {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  priority: 'high' | 'medium' | 'low';\r\n  timeEstimate: number;\r\n  completed: boolean;\r\n  createdAt: Date;\r\n  category?: string;\r\n  dueDate?: string;\r\n  focusMode?: boolean;\r\n}\r\n\r\nexport interface Goal {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  category: string;\r\n  targetDate?: string;\r\n  createdAt: Date;\r\n  milestones: Milestone[];\r\n  progress: number;\r\n  status: 'active' | 'completed' | 'paused';\r\n  color: string;\r\n}\r\n\r\nexport interface Milestone {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  completed: boolean;\r\n  dueDate?: string;\r\n  completedDate?: string;\r\n  order: number;\r\n}\r\n\r\n// AI Config\r\nexport interface AIConfig {\r\n  featuresEnabled: boolean;\r\n  dailyBrainEnabled: boolean;\r\n  coachEnabled: boolean;\r\n}\r\n\r\nexport const aiConfig: AIConfig = {\r\n  featuresEnabled: process.env.NEXT_PUBLIC_AI_FEATURES_ENABLED === 'true',\r\n  dailyBrainEnabled: process.env.AI_DAILY_BRAIN_ENABLED === 'true',\r\n  coachEnabled: process.env.AI_COACH_ENABLED === 'true',\r\n};\r\n\r\n// Default profile for new users\r\nexport function getDefaultProfile(): Omit<UserAIProfile, 'id' | 'user_id' | 'created_at' | 'updated_at'> {\r\n  return {\r\n    optimal_focus_duration: 25,\r\n    preferred_work_start_hour: 9,\r\n    preferred_work_end_hour: 17,\r\n    preferred_break_duration: 5,\r\n    most_productive_hours: [9, 10, 11],\r\n    common_distraction_times: [],\r\n    hourly_performance_scores: new Array(24).fill(0.5),\r\n    total_plans_generated: 0,\r\n    total_plans_accepted: 0,\r\n    total_plans_rejected: 0,\r\n    avg_plan_acceptance_rate: 0,\r\n    last_analyzed_date: null,\r\n  };\r\n}\r\n\r\n"],"names":[],"mappings":"AAAA,6BAA6B;;;;;;;AA0KtB,MAAM,WAAqB;IAChC,iBAAiB,QAAQ,GAAG,CAAC,+BAA+B,KAAK;IACjE,mBAAmB,QAAQ,GAAG,CAAC,sBAAsB,KAAK;IAC1D,cAAc,QAAQ,GAAG,CAAC,gBAAgB,KAAK;AACjD;AAGO,SAAS;IACd,OAAO;QACL,wBAAwB;QACxB,2BAA2B;QAC3B,yBAAyB;QACzB,0BAA0B;QAC1B,uBAAuB;YAAC;YAAG;YAAI;SAAG;QAClC,0BAA0B,EAAE;QAC5B,2BAA2B,IAAI,MAAM,IAAI,IAAI,CAAC;QAC9C,uBAAuB;QACvB,sBAAsB;QACtB,sBAAsB;QACtB,0BAA0B;QAC1B,oBAAoB;IACtB;AACF"}},
    {"offset": {"line": 624, "column": 0}, "map": {"version":3,"sources":["file:///D:/5th%20sem/PULSE-AI-PROJECT/app/api/ai/generate-plan/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { generateScheduleWithFallback } from '@/lib/ai/schedule-generator';\r\nimport { getUserAIProfile, ensureUserProfile } from '@/lib/services/personalization-service';\r\nimport { getRecentAggregates } from '@/lib/services/aggregation-service';\r\nimport { logAIEvent, logAIError, logAIFeatureUsage } from '@/lib/ai/logger';\r\nimport type { ScheduleContext, Task, Goal } from '@/lib/ai/types';\r\nimport { getDefaultProfile, aiConfig } from '@/lib/ai/types';\r\n\r\n/**\r\n * Manual Plan Generation Endpoint\r\n * \r\n * Allows users to regenerate their daily plan on-demand.\r\n * This is useful when:\r\n * - The user rejected the automatic plan\r\n * - They want a fresh plan after task changes\r\n * - No automatic plan was generated\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  // Check if AI features are enabled\r\n  if (!aiConfig.featuresEnabled) {\r\n    return NextResponse.json({ \r\n      error: 'AI features are disabled' \r\n    }, { status: 503 });\r\n  }\r\n\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const supabase = await createClient();\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    logAIFeatureUsage('manual_plan_generation', user.id);\r\n\r\n    // Build context for schedule generation\r\n    const context = await buildContextForUser(supabase, user.id);\r\n\r\n    // Generate schedule\r\n    const schedule = await generateScheduleWithFallback(user.id, context);\r\n\r\n    const todayStr = new Date().toISOString().split('T')[0];\r\n\r\n    // Store the plan\r\n    const { data: savedPlan, error: upsertError } = await supabase\r\n      .from('ai_plans')\r\n      .upsert({\r\n        user_id: user.id,\r\n        plan_date: todayStr,\r\n        schedule: schedule.schedule,\r\n        explanation: schedule.explanation,\r\n        reasoning: schedule.reasoning,\r\n        model_version: schedule.modelVersion,\r\n        status: 'pending',\r\n        generated_at: new Date().toISOString(),\r\n      }, { onConflict: 'user_id,plan_date' })\r\n      .select()\r\n      .single();\r\n\r\n    if (upsertError) {\r\n      throw new Error(`Failed to store plan: ${upsertError.message}`);\r\n    }\r\n\r\n    const latency = Date.now() - startTime;\r\n\r\n    logAIEvent('manual_plan_generated', {\r\n      userId: user.id,\r\n      latencyMs: latency,\r\n      scheduleItems: schedule.schedule.length,\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      plan: savedPlan,\r\n      latencyMs: latency,\r\n    });\r\n\r\n  } catch (error) {\r\n    const latency = Date.now() - startTime;\r\n    logAIError(error as Error, { \r\n      operation: 'manual_plan_generation',\r\n      latencyMs: latency,\r\n    });\r\n\r\n    return NextResponse.json({ \r\n      error: (error as Error).message,\r\n      latencyMs: latency,\r\n    }, { status: 500 });\r\n  }\r\n}\r\n\r\n/**\r\n * Builds schedule context for a user using the authenticated client.\r\n */\r\nasync function buildContextForUser(\r\n  supabase: Awaited<ReturnType<typeof createClient>>,\r\n  userId: string\r\n): Promise<ScheduleContext> {\r\n  // Fetch all required data in parallel\r\n  const [userRes, profileRes, aggregatesRes, tasksRes, goalsRes] = await Promise.all([\r\n    supabase.from('users').select('name').eq('id', userId).single(),\r\n    supabase.from('user_ai_profiles').select('*').eq('user_id', userId).single(),\r\n    supabase.from('daily_aggregates').select('*').eq('user_id', userId)\r\n      .order('date', { ascending: false }).limit(14),\r\n    supabase.from('tasks').select('*').eq('user_id', userId).eq('completed', false)\r\n      .order('created_at', { ascending: false }),\r\n    supabase.from('goals').select('*').eq('user_id', userId).eq('status', 'active'),\r\n  ]);\r\n\r\n  // Map tasks to expected format\r\n  const tasks: Task[] = (tasksRes.data || []).map(t => ({\r\n    id: t.id,\r\n    title: t.title,\r\n    description: t.description || undefined,\r\n    priority: t.priority as 'high' | 'medium' | 'low',\r\n    timeEstimate: t.time_estimate || 30,\r\n    completed: t.completed || false,\r\n    createdAt: new Date(t.created_at),\r\n    category: t.category || undefined,\r\n    dueDate: t.due_date || undefined,\r\n    focusMode: t.focus_mode || false,\r\n  }));\r\n\r\n  // Map goals to expected format\r\n  const goals: Goal[] = (goalsRes.data || []).map(g => ({\r\n    id: g.id,\r\n    title: g.title,\r\n    description: g.description || undefined,\r\n    category: g.category,\r\n    targetDate: g.target_date || undefined,\r\n    createdAt: new Date(g.created_at),\r\n    milestones: [],\r\n    progress: g.progress || 0,\r\n    status: g.status as 'active' | 'completed' | 'paused',\r\n    color: g.color,\r\n  }));\r\n\r\n  // Get profile or create default\r\n  let profile = profileRes.data;\r\n  if (!profile) {\r\n    profile = {\r\n      ...getDefaultProfile(),\r\n      user_id: userId,\r\n      id: '',\r\n      created_at: '',\r\n      updated_at: '',\r\n    };\r\n  }\r\n\r\n  return {\r\n    user: {\r\n      name: userRes.data?.name || 'User',\r\n      timezone: 'UTC',\r\n    },\r\n    profile: profile as any,\r\n    recentAggregates: (aggregatesRes.data || []) as any[],\r\n    todaysTasks: tasks,\r\n    activeGoals: goals,\r\n    currentTime: new Date().toTimeString().slice(0, 5),\r\n  };\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}